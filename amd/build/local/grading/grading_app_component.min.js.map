{"version":3,"file":"grading_app_component.min.js","sources":["../../../src/local/grading/grading_app_component.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JS for the competvet Grading App UI.\n *\n * @module     mod_competvet/local/grading/grading_app_component\n * @copyright  2024 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Repository from '../new-repository';\nimport CompetState from '../competstate';\nimport './components/user_navigation';\nimport './components/evaluations_grading';\nimport './components/list_grading';\nimport './components/globalgrade';\nimport './components/certification_grading';\nimport './components/certification_results';\nimport './components/list_results';\nimport './components/evaluation_results';\nimport './components/evaluation_chart';\nimport './components/subgrades';\nimport {getLetterGrade} from '../helpers';\nimport {getString} from 'core/str';\n\n/**\n * Constants for eval certif and list.\n */\nconst COMPETVET_CRITERIA_LIST = 3;\n\n\nclass Competvet {\n    /*\n     * The Grading App Element.\n     */\n    gradingApp;\n\n    /*\n    * The cmid.\n    */\n    competvet;\n\n    /*\n    * The Current User.\n    */\n    currentUser;\n\n    /**\n     * Constructor.\n     */\n    constructor() {\n        this.gradingApp = document.querySelector('[data-region=\"grading-app\"]');\n        this.cmId = this.gradingApp.dataset.cmId;\n        this.evalgrid = this.gradingApp.dataset.evalgrid;\n        this.certifgrid = this.gradingApp.dataset.certifgrid;\n        this.listgrid = this.gradingApp.dataset.listgrid;\n        this.planning = {\n            id: this.gradingApp.dataset.planningid,\n            situationid: this.gradingApp.dataset.situationid,\n            cmid: this.cmId,\n        };\n        CompetState.setValue('planning', this.planning);\n        this.userlist = [];\n        this.currentUser = 0;\n        this.setup();\n        this.addEventListeners();\n    }\n\n    /**\n     * Main render call.\n     */\n    async setup() {\n        await this.getUsers();\n        const currentUserId = this.gradingApp.dataset.studentid;\n        if (currentUserId && currentUserId !== '0') {\n            this.setCurrentUser(this.userlist.find(user => user.id === parseInt(currentUserId)));\n        } else {\n            this.setCurrentUser(this.userlist[0]);\n        }\n    }\n\n    /**\n     * Set the current user.\n     * @param {Object} user The user to set as current.\n     */\n    async setCurrentUser(user) {\n        this.gradingApp.dataset.studentid = user.id;\n        user.cangrade = this.gradingApp.dataset.cangrade == 1;\n        CompetState.setValue('user', user);\n        this.currentUser = user;\n\n        await this.setEvalResults();\n        await this.setCertifResults();\n        await this.setListResults();\n\n        await this.getScale();\n\n        await this.setListGrading();\n        await this.setSubGrades();\n        await this.setGlobalGrade();\n        await this.setForms();\n        setTimeout(() => {\n            this.setSuggestedGrade();\n        }, 500);\n    }\n\n    async setEvalResults() {\n        const args = {\n            studentid: this.currentUser.id,\n            planningid: this.planning.id\n        };\n        const evalResponse = await Repository.getEvalResults(args);\n        CompetState.setValue('evaluation-results', evalResponse);\n        CompetState.setValue('evaluation-chart', evalResponse);\n    }\n\n    async setCertifResults() {\n        const args = {\n            studentid: this.currentUser.id,\n            planningid: this.planning.id\n        };\n        const certResponse = await Repository.getCertifResults(args);\n        CompetState.setValue('certification-results', certResponse);\n    }\n\n    async setListResults() {\n        const args = {\n            userid: this.currentUser.id,\n            planningid: this.planning.id\n        };\n        const response = await Repository.getListResults(args);\n        CompetState.setValue('list-results', response);\n    }\n\n    /**\n     * Get the scale.\n     * @return {Promise} The promise.\n     */\n    async getScale() {\n        const args = {\n            cmid: this.cmId,\n        };\n        const response = await Repository.getLetterGradeScale(args);\n        CompetState.setValue('scale', JSON.parse(response.scale));\n    }\n\n    /**\n     * Get the list criteria.\n     */\n    async setListGrading() {\n        const args = {\n            type: COMPETVET_CRITERIA_LIST,\n            gridid: this.listgrid,\n        };\n        const response = await Repository.getCriteria(args);\n        if (!response.grids) {\n            return;\n        }\n        const context = {\n            grading: {\n                'criteria': response.grids[0].criteria,\n                'timemodified': response.grids[0].timemodified,\n                'cangrade': this.gradingApp.dataset.cangrade == 1,\n            },\n        };\n        context.grading.criteria.forEach(criterion => {\n            // Set the option with the second sortorder as the default selected option.\n            criterion.options[1].selected = true;\n        });\n        CompetState.setValue('list-grading', context);\n    }\n\n    /**\n     * Get the list of users for grading.\n     */\n    async getUsers() {\n        const args = {\n            planningid: this.planning.id\n        };\n        const response = await Repository.getStudentList(args);\n        if (!response.users) {\n            return;\n        }\n        this.userlist = response.users;\n        CompetState.setValue('userlist', this.userlist);\n    }\n\n    /**\n     * Set the global grade.\n     */\n    async setGlobalGrade() {\n        const args = {\n            cmid: this.cmId,\n            planningid: this.planning.id,\n            userid: this.currentUser.id\n        };\n        const response = await Repository.getGlobalGrade(args);\n        if (!response.result) {\n            return;\n        }\n        response.result.hideaccept = true;\n        CompetState.setValue('globalgrade', response.result);\n    }\n\n    /**\n     * Set the subgrades.\n     */\n    async setSubGrades() {\n        const args = {\n            studentid: this.currentUser.id,\n            planningid: this.planning.id\n        };\n        const response = await Repository.getSubGrades(args);\n        CompetState.setValue('subgrades', response);\n    }\n\n    /**\n     * Set the suggested grade.\n     */\n    async setSuggestedGrade() {\n        const suggestedArgs = {\n            studentid: this.currentUser.id,\n            planningid: this.planning.id,\n        };\n        const globalGrade = CompetState.getValue('globalgrade');\n        const response = await Repository.getSuggestedGrade(suggestedArgs);\n        globalGrade.suggestedgrade = response.suggestedgrade;\n        globalGrade.gradecalculation = response.gradecalculation;\n        globalGrade.hideaccept = response.suggestedgrade == 0 || response.suggestedgrade == globalGrade.finalgrade;\n        CompetState.setValue('globalgrade', globalGrade);\n    }\n\n    /**\n     * Set the forms.\n     */\n    async setForms() {\n        const forms = ['evaluations-grading', 'certification-grading', 'list-grading'];\n        await Promise.all(forms.map(async(formname) => {\n            const args = {\n                userid: this.currentUser.id,\n                planningid: this.gradingApp.dataset.planningid,\n                formname: formname\n            };\n            const response = await Repository.getFormData(args);\n            if (!response.result) {\n                return;\n            }\n            const context = {\n                grading: JSON.parse(response.data),\n                cangrade: this.gradingApp.dataset.cangrade == 1,\n            };\n            // For the list-grading we need to check the timemodified against the stored form timemodified.\n            if (formname === 'list-grading') {\n                const listGrading = CompetState.getValue('list-grading');\n                if (context.grading.scoreevaluator) {\n                    context.grading.lettergrade = getLetterGrade(context.grading.scoreevaluator);\n                }\n                if (listGrading.grading.timemodified > response.timemodified) {\n                    window.console.log('List grading form is outdated:' + listGrading.grading.timemodified +\n                        ' ' + response.timemodified);\n                    return;\n                }\n            }\n            if (formname === 'certification-grading') {\n                this.setCertifFormValues(context);\n            }\n            if (formname === 'evaluations-grading') {\n                this.setEvalFormValues(context);\n            }\n            CompetState.setValue(formname, context);\n        }));\n    }\n\n    async setCertifFormValues(context) {\n        const certifResults = CompetState.getValue('certification-results');\n        context.grading.numcertifvalidated = certifResults.numvalidated;\n        context.grading.maxcertifvalidated = certifResults.numcertifications;\n        context.grading.statusproposed = certifResults.statusproposed;\n        context.grading.certifpnum = certifResults.certifpnum;\n        context.grading.certifnum = certifResults.certifnum;\n        // We need to give the template the litteral string as {{#str}} {{value}} {{/str}} does not work.\n        for (const option of context.grading.evaloptions) {\n            option.valuestring = await getString(option.value === 'validated' ? 'validated' : 'notvalidated', 'mod_competvet');\n            option.selected = false;\n            if (option.value === 'validated' && context.grading.statusproposed === true) {\n                option.selected = true;\n            }\n            if (option.value === 'notvalidated' && context.grading.statusproposed !== true) {\n                option.selected = true;\n            }\n        }\n    }\n\n    /**\n     * Set the Evaluation form values.\n     * @param {Object} context The context to set the values in\n     */\n    setEvalFormValues(context) {\n        const evalResults = CompetState.getValue('evaluation-results');\n        // Update the values numberofobservations and maxobservations based on the evaluation-results\n        context.grading.evalnum = this.gradingApp.dataset.evalnum;\n        context.grading.lettergrade = getLetterGrade(context.grading.scoreevaluator);\n\n        let numberofobservations = evalResults.numberofobservations;\n        let numberofselfevaluations = evalResults.autoevals.length;\n        let noSelfEvalPenalty = -30;\n        if (numberofselfevaluations > 0) {\n            context.grading.selfevalselectoptions[1].selected = true;\n            noSelfEvalPenalty = 0;\n        }\n        context.grading.numberofobservations = numberofobservations;\n        context.grading.haspenalty = context.grading.evalnum > numberofobservations;\n\n        context.grading.evalscore = evalResults.totalaverage;\n        let penalty = context.grading.deactivatepenalty ? 0 : 1;\n        penalty = context.grading.haspenalty * penalty;\n        context.grading.finalscore = context.grading.evalscore +\n            (context.grading.penalty * penalty) + noSelfEvalPenalty;\n        if (context.grading.finalscore < 0) {\n            context.grading.finalscore = 0;\n        }\n    }\n\n    /**\n     * Set the current user\n     * @param {string} direction The direction to move.\n     */\n    moveUser(direction) {\n        let index = this.userlist.indexOf(this.currentUser);\n        if (direction === 'prev' && index > 0) {\n            this.setCurrentUser(this.userlist[index - 1]);\n        } else if (direction === 'next' && index < this.userlist.length - 1) {\n            this.setCurrentUser(this.userlist[index + 1]);\n        }\n    }\n\n    /**\n     * Add event listeners.\n     */\n    addEventListeners() {\n        document.addEventListener('click', async(event) => {\n            if (event.target.closest('[data-action=\"prevuser\"]')) {\n                this.moveUser('prev');\n            }\n            if (event.target.closest('[data-action=\"nextuser\"]')) {\n                this.moveUser('next');\n            }\n            if (event.target.closest('[data-action=\"setuser\"]')) {\n                const userId = event.target.closest('[data-action=\"setuser\"]').dataset.userid;\n                this.setCurrentUser(this.userlist.find(user => user.id === parseInt(userId)));\n            }\n            if (event.target.closest('[data-action=\"reload\"]')) {\n                this.getEvaluations();\n            }\n        });\n        this.gradingApp.addEventListener('certAdded', () => {\n            this.setCertifResults();\n        });\n        this.gradingApp.addEventListener('setSuggestedGrade', async() => {\n            // Update the suggested grade.\n            this.setSubGrades();\n            this.setSuggestedGrade();\n        });\n    }\n}\n\n/*\n * Initialise the criteria management.\n *\n */\nconst init = () => {\n    new Competvet();\n};\n\nexport default {\n    init: init,\n};"],"names":["Competvet","constructor","gradingApp","document","querySelector","cmId","this","dataset","evalgrid","certifgrid","listgrid","planning","id","planningid","situationid","cmid","setValue","userlist","currentUser","setup","addEventListeners","getUsers","currentUserId","studentid","setCurrentUser","find","user","parseInt","cangrade","setEvalResults","setCertifResults","setListResults","getScale","setListGrading","setSubGrades","setGlobalGrade","setForms","setTimeout","setSuggestedGrade","args","evalResponse","Repository","getEvalResults","certResponse","getCertifResults","userid","response","getListResults","getLetterGradeScale","JSON","parse","scale","type","gridid","getCriteria","grids","context","grading","criteria","timemodified","forEach","criterion","options","selected","getStudentList","users","getGlobalGrade","result","hideaccept","getSubGrades","suggestedArgs","globalGrade","CompetState","getValue","getSuggestedGrade","suggestedgrade","gradecalculation","finalgrade","Promise","all","map","async","formname","getFormData","data","listGrading","scoreevaluator","lettergrade","window","console","log","setCertifFormValues","setEvalFormValues","certifResults","numcertifvalidated","numvalidated","maxcertifvalidated","numcertifications","statusproposed","certifpnum","certifnum","option","evaloptions","valuestring","value","evalResults","evalnum","numberofobservations","noSelfEvalPenalty","autoevals","length","selfevalselectoptions","haspenalty","evalscore","totalaverage","penalty","deactivatepenalty","finalscore","moveUser","direction","index","indexOf","addEventListener","event","target","closest","userId","getEvaluations","init"],"mappings":"8lCA2CMA,UAmBFC,iJACSC,WAAaC,SAASC,cAAc,oCACpCC,KAAOC,KAAKJ,WAAWK,QAAQF,UAC/BG,SAAWF,KAAKJ,WAAWK,QAAQC,cACnCC,WAAaH,KAAKJ,WAAWK,QAAQE,gBACrCC,SAAWJ,KAAKJ,WAAWK,QAAQG,cACnCC,SAAW,CACZC,GAAIN,KAAKJ,WAAWK,QAAQM,WAC5BC,YAAaR,KAAKJ,WAAWK,QAAQO,YACrCC,KAAMT,KAAKD,2BAEHW,SAAS,WAAYV,KAAKK,eACjCM,SAAW,QACXC,YAAc,OACdC,aACAC,wCAOCd,KAAKe,iBACLC,cAAgBhB,KAAKJ,WAAWK,QAAQgB,UAC1CD,eAAmC,MAAlBA,mBACZE,eAAelB,KAAKW,SAASQ,MAAKC,MAAQA,KAAKd,KAAOe,SAASL,uBAE/DE,eAAelB,KAAKW,SAAS,yBAQrBS,WACZxB,WAAWK,QAAQgB,UAAYG,KAAKd,GACzCc,KAAKE,SAA+C,GAApCtB,KAAKJ,WAAWK,QAAQqB,8BAC5BZ,SAAS,OAAQU,WACxBR,YAAcQ,WAEbpB,KAAKuB,uBACLvB,KAAKwB,yBACLxB,KAAKyB,uBAELzB,KAAK0B,iBAEL1B,KAAK2B,uBACL3B,KAAK4B,qBACL5B,KAAK6B,uBACL7B,KAAK8B,WACXC,YAAW,UACFC,sBACN,kCAIGC,KAAO,CACThB,UAAWjB,KAAKY,YAAYN,GAC5BC,WAAYP,KAAKK,SAASC,IAExB4B,mBAAqBC,uBAAWC,eAAeH,2BACzCvB,SAAS,qBAAsBwB,mCAC/BxB,SAAS,mBAAoBwB,6CAInCD,KAAO,CACThB,UAAWjB,KAAKY,YAAYN,GAC5BC,WAAYP,KAAKK,SAASC,IAExB+B,mBAAqBF,uBAAWG,iBAAiBL,2BAC3CvB,SAAS,wBAAyB2B,2CAIxCJ,KAAO,CACTM,OAAQvC,KAAKY,YAAYN,GACzBC,WAAYP,KAAKK,SAASC,IAExBkC,eAAiBL,uBAAWM,eAAeR,2BACrCvB,SAAS,eAAgB8B,iCAQ/BP,KAAO,CACTxB,KAAMT,KAAKD,MAETyC,eAAiBL,uBAAWO,oBAAoBT,2BAC1CvB,SAAS,QAASiC,KAAKC,MAAMJ,SAASK,qCAO5CZ,KAAO,CACTa,KA3HoB,EA4HpBC,OAAQ/C,KAAKI,UAEXoC,eAAiBL,uBAAWa,YAAYf,UACzCO,SAASS,mBAGRC,QAAU,CACZC,QAAS,UACOX,SAASS,MAAM,GAAGG,sBACdZ,SAASS,MAAM,GAAGI,sBACc,GAApCrD,KAAKJ,WAAWK,QAAQqB,WAG5C4B,QAAQC,QAAQC,SAASE,SAAQC,YAE7BA,UAAUC,QAAQ,GAAGC,UAAW,0BAExB/C,SAAS,eAAgBwC,gCAO/BjB,KAAO,CACT1B,WAAYP,KAAKK,SAASC,IAExBkC,eAAiBL,uBAAWuB,eAAezB,MAC5CO,SAASmB,aAGThD,SAAW6B,SAASmB,2BACbjD,SAAS,WAAYV,KAAKW,wCAOhCsB,KAAO,CACTxB,KAAMT,KAAKD,KACXQ,WAAYP,KAAKK,SAASC,GAC1BiC,OAAQvC,KAAKY,YAAYN,IAEvBkC,eAAiBL,uBAAWyB,eAAe3B,MAC5CO,SAASqB,SAGdrB,SAASqB,OAAOC,YAAa,uBACjBpD,SAAS,cAAe8B,SAASqB,oCAOvC5B,KAAO,CACThB,UAAWjB,KAAKY,YAAYN,GAC5BC,WAAYP,KAAKK,SAASC,IAExBkC,eAAiBL,uBAAW4B,aAAa9B,2BACnCvB,SAAS,YAAa8B,0CAO5BwB,cAAgB,CAClB/C,UAAWjB,KAAKY,YAAYN,GAC5BC,WAAYP,KAAKK,SAASC,IAExB2D,YAAcC,qBAAYC,SAAS,eACnC3B,eAAiBL,uBAAWiC,kBAAkBJ,eACpDC,YAAYI,eAAiB7B,SAAS6B,eACtCJ,YAAYK,iBAAmB9B,SAAS8B,iBACxCL,YAAYH,WAAwC,GAA3BtB,SAAS6B,gBAAuB7B,SAAS6B,gBAAkBJ,YAAYM,gCACpF7D,SAAS,cAAeuD,oCAQ9BO,QAAQC,IADA,CAAC,sBAAuB,wBAAyB,gBACvCC,KAAIC,MAAAA,iBAClB1C,KAAO,CACTM,OAAQvC,KAAKY,YAAYN,GACzBC,WAAYP,KAAKJ,WAAWK,QAAQM,WACpCqE,SAAUA,UAERpC,eAAiBL,uBAAW0C,YAAY5C,UACzCO,SAASqB,oBAGRX,QAAU,CACZC,QAASR,KAAKC,MAAMJ,SAASsC,MAC7BxD,SAA8C,GAApCtB,KAAKJ,WAAWK,QAAQqB,aAGrB,iBAAbsD,SAA6B,OACvBG,YAAcb,qBAAYC,SAAS,mBACrCjB,QAAQC,QAAQ6B,iBAChB9B,QAAQC,QAAQ8B,aAAc,2BAAe/B,QAAQC,QAAQ6B,iBAE7DD,YAAY5B,QAAQE,aAAeb,SAASa,yBAC5C6B,OAAOC,QAAQC,IAAI,iCAAmCL,YAAY5B,QAAQE,aACtE,IAAMb,SAASa,cAIV,0BAAbuB,eACKS,oBAAoBnC,SAEZ,wBAAb0B,eACKU,kBAAkBpC,8BAEfxC,SAASkE,SAAU1B,uCAIbA,eAChBqC,cAAgBrB,qBAAYC,SAAS,yBAC3CjB,QAAQC,QAAQqC,mBAAqBD,cAAcE,aACnDvC,QAAQC,QAAQuC,mBAAqBH,cAAcI,kBACnDzC,QAAQC,QAAQyC,eAAiBL,cAAcK,eAC/C1C,QAAQC,QAAQ0C,WAAaN,cAAcM,WAC3C3C,QAAQC,QAAQ2C,UAAYP,cAAcO,cAErC,MAAMC,UAAU7C,QAAQC,QAAQ6C,YACjCD,OAAOE,kBAAoB,kBAA2B,cAAjBF,OAAOG,MAAwB,YAAc,eAAgB,iBAClGH,OAAOtC,UAAW,EACG,cAAjBsC,OAAOG,QAA4D,IAAnChD,QAAQC,QAAQyC,iBAChDG,OAAOtC,UAAW,GAED,iBAAjBsC,OAAOG,QAA+D,IAAnChD,QAAQC,QAAQyC,iBACnDG,OAAOtC,UAAW,GAS9B6B,kBAAkBpC,eACRiD,YAAcjC,qBAAYC,SAAS,sBAEzCjB,QAAQC,QAAQiD,QAAUpG,KAAKJ,WAAWK,QAAQmG,QAClDlD,QAAQC,QAAQ8B,aAAc,2BAAe/B,QAAQC,QAAQ6B,oBAEzDqB,qBAAuBF,YAAYE,qBAEnCC,mBAAqB,GADKH,YAAYI,UAAUC,OAEtB,IAC1BtD,QAAQC,QAAQsD,sBAAsB,GAAGhD,UAAW,EACpD6C,kBAAoB,GAExBpD,QAAQC,QAAQkD,qBAAuBA,qBACvCnD,QAAQC,QAAQuD,WAAaxD,QAAQC,QAAQiD,QAAUC,qBAEvDnD,QAAQC,QAAQwD,UAAYR,YAAYS,iBACpCC,QAAU3D,QAAQC,QAAQ2D,kBAAoB,EAAI,EACtDD,QAAU3D,QAAQC,QAAQuD,WAAaG,QACvC3D,QAAQC,QAAQ4D,WAAa7D,QAAQC,QAAQwD,UACxCzD,QAAQC,QAAQ0D,QAAUA,QAAWP,kBACtCpD,QAAQC,QAAQ4D,WAAa,IAC7B7D,QAAQC,QAAQ4D,WAAa,GAQrCC,SAASC,eACDC,MAAQlH,KAAKW,SAASwG,QAAQnH,KAAKY,aACrB,SAAdqG,WAAwBC,MAAQ,OAC3BhG,eAAelB,KAAKW,SAASuG,MAAQ,IACrB,SAAdD,WAAwBC,MAAQlH,KAAKW,SAAS6F,OAAS,QACzDtF,eAAelB,KAAKW,SAASuG,MAAQ,IAOlDpG,oBACIjB,SAASuH,iBAAiB,SAASzC,MAAAA,WAC3B0C,MAAMC,OAAOC,QAAQ,kCAChBP,SAAS,QAEdK,MAAMC,OAAOC,QAAQ,kCAChBP,SAAS,QAEdK,MAAMC,OAAOC,QAAQ,2BAA4B,OAC3CC,OAASH,MAAMC,OAAOC,QAAQ,2BAA2BtH,QAAQsC,YAClErB,eAAelB,KAAKW,SAASQ,MAAKC,MAAQA,KAAKd,KAAOe,SAASmG,WAEpEH,MAAMC,OAAOC,QAAQ,gCAChBE,yBAGR7H,WAAWwH,iBAAiB,aAAa,UACrC5F,2BAEJ5B,WAAWwH,iBAAiB,qBAAqBzC,eAE7C/C,oBACAI,qCAaF,CACX0F,KALS,SACLhI"}